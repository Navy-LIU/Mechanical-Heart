# 增强版MQTT云台管理器

这是一个增强版的MQTT云台管理程序，在原有的自动/手动模式切换功能基础上，新增了以下两个重要事件：

1. **服务器控制云台事件** - 服务器可以直接控制云台的移动、缩放等操作
2. **云台状态发布事件** - 云台定期发布自己的当前状态信息

## 新增功能

### 1. 云台控制事件 (`camera/gimbal/control`)

服务器可以通过此主题发送控制指令来控制云台：

#### 支持的控制指令：

##### 移动控制
```json
{
  "command": "move",
  "pan": 45,        // 水平角度 (-180 到 180)
  "tilt": -30,      // 俯仰角度 (-90 到 90)  
  "speed": 1.5      // 移动速度 (可选，默认1.0)
}
```

##### 缩放控制
```json
{
  "command": "zoom",
  "zoom": 2.0       // 缩放倍数
}
```

##### 预设位置
```json
{
  "command": "preset",
  "preset_id": 1    // 预设位置ID (1-4)
}
```

预设位置定义：
- 1: 正前方 (pan: 0°, tilt: 0°)
- 2: 右前方俯视 (pan: 90°, tilt: -30°)
- 3: 左前方俯视 (pan: -90°, tilt: -30°)
- 4: 正后方 (pan: 180°, tilt: 0°)

##### 校准
```json
{
  "command": "calibrate"
}
```

##### 重置
```json
{
  "command": "reset"
}
```

### 2. 云台状态发布事件 (`camera/gimbal/status`)

云台每秒自动发布一次状态信息：

```json
{
  "pan": 0.0,           // 当前水平角度
  "tilt": 0.0,          // 当前俯仰角度
  "roll": 0.0,          // 当前翻滚角度
  "zoom": 1.0,          // 当前缩放倍数
  "mode": "tracking",   // 当前模式: idle/tracking/manual_control
  "online": true,       // 是否在线
  "battery": 100,       // 电池电量百分比
  "timestamp": 1640995200000  // 时间戳(毫秒)
}
```

## 原有功能保持不变

### 模式切换事件 (`camera/manager/set_mode`)

```json
{"mode": "auto"}    // 切换到自动追踪模式
{"mode": "manual"}  // 切换到手动控制模式
```

### 自动进程控制事件 (`camera/tracking/set_mode`)

```json
{"mode": "auto"}    // 开始自动追踪
{"mode": "pause"}   // 暂停自动追踪
```

## 文件说明

- `enhanced_mqtt_manager.py` - 增强版主程序
- `test_gimbal_control.py` - 功能测试脚本
- `README.md` - 本说明文档

## 使用方法

### 1. 运行主程序
```bash
python3 enhanced_mqtt_manager.py
```

### 2. 运行测试脚本（在另一个终端）
```bash
python3 test_gimbal_control.py
```

## 程序架构

```
MQTT Broker (192.168.137.1:1883)
    │
    ├── camera/manager/set_mode         (原有：模式切换)
    ├── camera/tracking/set_mode        (原有：自动进程控制)
    ├── camera/gimbal/control          (新增：云台控制)
    └── camera/gimbal/status           (新增：状态发布)
                │
                ├── 自动进程 (C++程序)
                ├── 手动进程 (Python程序)
                └── 状态发布线程
```

## 技术特点

1. **非阻塞式状态发布** - 使用独立线程每秒发布一次云台状态
2. **多种控制方式** - 支持精确角度控制、预设位置、校准和重置
3. **状态同步** - 云台状态与工作模式实时同步
4. **错误处理** - 完善的异常处理和日志输出
5. **向后兼容** - 完全保持原有功能不变

## 扩展说明

在实际部署时，需要根据具体的云台硬件接口来实现：

1. **硬件控制接口** - 替换模拟的云台控制代码为实际的硬件控制调用
2. **状态反馈** - 从实际硬件获取云台位置和状态信息
3. **配置参数** - 根据云台规格调整角度范围和速度参数

## 注意事项

1. 请确保MQTT服务器地址配置正确
2. 确保所有进程路径配置正确
3. 在生产环境中，建议增加身份验证和权限控制
4. 监控网络连接状态，必要时实现重连机制